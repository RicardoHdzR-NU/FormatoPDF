<!DOCTYPE html>
<html>
<head>
    <title>Rellenar campos de formulario en PDF con JavaScript</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.16.0/pdf-lib.js"></script>
</head>
<body>
    <input type="text" id="nombre" placeholder="Nombre">
    <input type="text" id="nPoliza" placeholder="Número de Poliza">
    <input type="text" id="telefono" placeholder="Teléfono">
    <input type="text" id="correo" placeholder="Correo">
    <input type="text" id="direccion" placeholder="Dirección">
    <input type="text" id="agente" placeholder="Agente">
    <input type="text" id="telAgente" placeholder="Telefono Agente">
    <input type="text" id="correoAgente" placeholder="Correo Agente">
    <input type="text" id="term" placeholder="Terminación">
    <input type="text" id="mmFrom" placeholder="Desde Mes">
    <input type="text" id="ddFrom" placeholder="Desde Día">
    <input type="text" id="yrFrom" placeholder="Desde año">
    <input type="text" id="mmTo" placeholder="Hasta Mes">
    <input type="text" id="ddTo" placeholder="Hasta Día">
    <input type="text" id="yrTo" placeholder="Hasta año">
    <input type="text" id="hora" placeholder="Hora">
    <input type="text" id="am/pm" placeholder="AM / PM">
    <input type="text" id="añoVeh" placeholder="Año de Vehiculo">
    <input type="text" id="marcaVeh" placeholder="Marca de Vehiculo">
    <input type="text" id="modVeh" placeholder="modelo de Vehiculo">
    <input type="text" id="vin" placeholder="VIN">
    <input type="text" id="placaEstado" placeholder="Estado de Placas">
    <input type="text" id="towed" placeholder="Towed">
    <input type="text" id="premium" placeholder="Premium">
    <input type="text" id="roadAssist" placeholder="Road Assist">
    <input type="text" id="policyFee" placeholder="Policy Fee">
    <input type="text" id="assistPlus" placeholder="Assist Plus">
    <input type="text" id="misc" placeholder="Misc">
    <input type="text" id="total" placeholder="Total">
    <input type="text" id="applicant" placeholder="Aplicante">
    <input type="text" id="driver2" placeholder="Conductor 2">
    <input type="text" id="elder/Underage" placeholder="Persona Mayor/Menor">
    <input type="text" id="applicantBirth" placeholder="Edad de Aplicante">
    <input type="text" id="driver2Birth" placeholder="Edad Conductor 2">
    <input type="text" id="eld/UndBirth" placeholder="Edad Persona Mayor/Menor">
    <input type="text" id="applicantLicense" placeholder="Licencia Aplicante">
    <input type="text" id="driver2License" placeholder="Licencia Conductor 2">
    <input type="text" id="eld/UndLicense" placeholder="Licencia Persona Mayor/Menor">
    <input type="text" id="initial" placeholder="Inicial">
    <button id="rellenarPDF">Rellenar PDF</button>
    <br>
    <script>
        // Función para rellenar campos de formulario en un PDF
        async function rellenarPDF(nombrePDF) {
            //console.log(nombrePDF)
            /*
                aquí se haría la consulta con el prefijo y folio
            */
            //aquí se deciciría que tipo de poliza llenar con el tipo de poliza que se obtuvo de la consulta
            //if(poliza.tipo == "Auto Turista") por ejemplo
            if(nombrePDF.prefijo == "AXW" && nombrePDF.folio == "353579629"){
            //if(nombrePDF == 'pdf-formulario'){
                const nombreDoc = 'pdf-formulario';

                //los datos a rellenar se obtendrían de la consulta
                const datosPDF = pdf1;
                // Cargar el PDF existente (reemplaza 'ruta-al-pdf.pdf' con la URL o la ruta local de tu PDF)
                const existingPdfBytes = await fetch(`test/${nombreDoc}.pdf`).then((res) => res.arrayBuffer());
                //console.log('bytes obtenidos: ' , existingPdfBytes)

                // Crear un documento PDF desde el PDF existente
                const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();
                //console.log('cargamos el formulario')

                // Rellenar los campos de formulario en el PDF
                form.getTextField('NombreAsegurado').setText(datosPDF.nombreAsegurado);
                form.getTextField('NumPoliza').setText(datosPDF.numPoliza);
                form.getTextField('TelAsegurado').setText(datosPDF.telAsegurado);
                form.getTextField('CorreoAsegurado').setText(datosPDF.correoAsegurado);
                form.getTextField('DireccionAsegurado').setText(datosPDF.direccionAsegurado)
                form.getTextField('Agente').setText(datosPDF.agente)
                form.getTextField('TelAgente').setText(datosPDF.telAgente)
                form.getTextField('CorreoAgente').setText(datosPDF.correoAgente)
                form.getTextField('Term').setText(datosPDF.term)
                form.getTextField('MMFrom').setText(datosPDF.mMFrom)
                form.getTextField('DDFrom').setText(datosPDF.dDFrom)
                form.getTextField('YRFrom').setText(datosPDF.yRFrom)
                form.getTextField('MMTo').setText(datosPDF.mMTo)
                form.getTextField('DDTo').setText(datosPDF.dDTo)
                form.getTextField('YRTo').setText(datosPDF.yRTo)
                form.getTextField('HR').setText(datosPDF.hR)
                form.getTextField('AM/PM').setText(datosPDF.aMPM)
                form.getTextField('AñoVeh').setText(datosPDF.añoVeh)
                form.getTextField('MarcaVeh').setText(datosPDF.marcaVeh)
                form.getTextField('ModeloVeh').setText(datosPDF.modeloVeh)
                form.getTextField('VIN').setText(datosPDF.vIN)
                form.getTextField('PlacaEstado').setText(datosPDF.placaEstado)
                form.getTextField('Towed').setText(datosPDF.towed)
                form.getTextField('Premium').setText(datosPDF.premium)
                form.getTextField('RoadAssist').setText(datosPDF.roadAssist)
                form.getTextField('PolicyFee').setText(datosPDF.policyFee)
                form.getTextField('AssistPlus').setText(datosPDF.assistPlus)
                form.getTextField('Misc').setText(datosPDF.misc)
                form.getTextField('Total').setText(datosPDF.total)
                form.getTextField('Applicant').setText(datosPDF.applicant)
                form.getTextField('Driver2').setText(datosPDF.driver2)
                form.getTextField('Elder/Underage').setText(datosPDF.elderUnderage)
                form.getTextField('ApplicantBirth').setText(datosPDF.applicantBirth)
                form.getTextField('Driver2Birth').setText(datosPDF.driver2Birth)
                form.getTextField('Eld/UndBirth').setText(datosPDF.eldUndBirth)
                form.getTextField('ApplicantLicense').setText(datosPDF.applicantLicense)
                form.getTextField('Driver2License').setText(datosPDF.driver2License)
                form.getTextField('Eld/UndLicense').setText(datosPDF.eldUndLicense)
                form.getTextField('Initial').setText(datosPDF.initial)
                form.flatten()

                // Generar un nuevo PDF con los campos de formulario llenados
                const pdfBytes = await pdfDoc.save();

                const pickerOpts = {
                    types: [
                    {
                        description: "PDF Document (.pdf)",
                        accept: {
                        "application/*": [".pdf"],
                        },
                    },
                    ],
                    excludeAcceptAllOption: true,
                    multiple: false,
                };

                /*const fileHandle = await window.showSaveFilePicker(pickerOpts);
                const fileStream = await fileHandle.createWritable();*/
                
                // Descargar el PDF resultante
                var blob = new Blob([pdfBytes], { type: 'application/pdf' });

                /*await fileStream.write(blob);
                await fileStream.close();*/

                var blobUrl = URL.createObjectURL(blob);
                var link = document.createElement("a"); // Or maybe get it from the current document
                const br = document.createElement("br");
                link.href = blobUrl;
                link.download = "polizaCarro.pdf";
                link.innerHTML = "Descarga Poliza de Carro";
                document.body.appendChild(link); // Or append it whereever you want
                document.body.appendChild(br)

            }
            else if(nombrePDF.prefijo == "AXW" && nombrePDF.folio == "353579570"){
            //else if(nombrePDF == 'Motorcycle_2023-formulario'){
                const nombreDoc = 'Motorcycle_2023-formulario';

                //los datos a rellenar se obtendrían de la consulta
                const datosPDF = pdf2;

                // Cargar el PDF existente (reemplaza 'ruta-al-pdf.pdf' con la URL o la ruta local de tu PDF)
                const existingPdfBytes = await fetch(`test/${nombreDoc}.pdf`).then((res) => res.arrayBuffer());
                //console.log('bytes obtenidos: ' , existingPdfBytes)

                // Crear un documento PDF desde el PDF existente
                const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
                const form = pdfDoc.getForm();
                //console.log('cargamos el formulario')

                // Rellenar los campos de formulario en el PDF
                form.getTextField('NombreAsegurado').setText(datosPDF.nombreAsegurado);
                form.getTextField('NumPoliza').setText(datosPDF.numPoliza);
                form.getTextField('TelAsegurado').setText(datosPDF.telAsegurado);
                
                form.flatten()

                // Generar un nuevo PDF con los campos de formulario llenados
                const pdfBytes = await pdfDoc.save();

                const pickerOpts = {
                    types: [
                    {
                        description: "PDF Document (.pdf)",
                        accept: {
                        "application/*": [".pdf"],
                        },
                    },
                    ],
                    excludeAcceptAllOption: true,
                    multiple: false,
                };

                /*const fileHandle = await window.showSaveFilePicker(pickerOpts);
                const fileStream = await fileHandle.createWritable();*/
                
                // Descargar el PDF resultante
                var blob = new Blob([pdfBytes], { type: 'application/pdf' });

                /*await fileStream.write(blob);
                await fileStream.close();*/

                var blobUrl = URL.createObjectURL(blob);
                var link = document.createElement("a"); // Or maybe get it from the current document
                const br = document.createElement("br");
                link.href = blobUrl;
                link.download = "polizaMoto.pdf";
                link.innerHTML = "Descarga Poliza de Moto";
                document.body.appendChild(link); // Or append it whereever you want
                document.body.appendChild(br)
            }
            
        }

        const pdf1 = {
            "numPoliza": "1",
            "nombreAsegurado": "Ricardo Hernandez",
            "telAsegurado": "8116610129",
        }

        const pdf2 = {
            "numPoliza": "2",
            "nombreAsegurado": "Ricardo Hernandez",
            "telAsegurado": "8116610129",
        }

        const consulta1 = {
            "prefijo": "AXW",
            "folio": "353579629"
        }

        const consulta2 = {
            "prefijo": "AXW",
            "folio": "353579570"
        }

        const PDFs = [
            consulta1,
            consulta2
        ]

        async function procesarPDF(){
            for(let i = 0; i<=PDFs.length; i++){
                await rellenarPDF(PDFs[i]) 
            }
        }
        // Asociar la función al botón
        document.getElementById('rellenarPDF').addEventListener('click', procesarPDF);
    </script>
</body>
</html>